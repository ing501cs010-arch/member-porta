<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div id="analyticsArea" class="hidden grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
    <div class="glass p-4 rounded-2xl border-b-4 border-green-500 text-center">
        <p class="text-xs text-gray-400">TOTAL DEPOSIT</p>
        <h3 id="sumDeposit" class="text-xl font-bold text-green-400">0</h3>
    </div>
    <div class="glass p-4 rounded-2xl border-b-4 border-red-500 text-center">
        <p class="text-xs text-gray-400">TOTAL WITHDRAW</p>
        <h3 id="sumWithdraw" class="text-xl font-bold text-red-400">0</h3>
    </div>
    <div class="glass p-4 rounded-2xl border-b-4 border-yellow-500 text-center">
        <p class="text-xs text-gray-400">TOTAL BONUS</p>
        <h3 id="sumBonus" class="text-xl font-bold text-yellow-400">0</h3>
    </div>
    <div class="glass p-4 rounded-2xl border-b-4 border-blue-500 text-center">
        <p class="text-xs text-gray-400">NET PROFIT</p>
        <h3 id="sumNet" class="text-xl font-bold text-blue-400">0</h3>
    </div>
</div>

<div id="chartContainer" class="hidden glass p-6 rounded-3xl mb-8">
    <canvas id="memberChart" style="max-height: 300px;"></canvas>
</div>

<script>
    let myChart = null; // Chart instance ကို သိမ်းရန်

    // Main Search Function ထဲမှာ ဒီ Logic တွေ ထည့်ပါမယ်
    async function searchMember() {
        // ... (fetch logic) ...
        
        if (res.status === "success" && res.data.length > 0) {
            calculateAnalytics(res.data); // Logic အသစ်
            renderChart(res.data);       // Chart ဆွဲရန်
            // ... (render cards) ...
        }
    }

    function calculateAnalytics(data) {
        let totalDep = 0, totalWit = 0, totalBon = 0;

        data.forEach(item => {
            // Header နာမည်တွေကို Sheet ထဲကအတိုင်း တိုက်စစ်ပါ
            totalDep += parseFloat(item.Deposit || item.Deposit_plus_ || 0);
            totalWit += parseFloat(item.Withdraw || item.Withdraw_minus_ || 0);
            totalBon += parseFloat(item.Bonus || item.Total_Bonus || 0);
        });

        document.getElementById('sumDeposit').innerText = totalDep.toLocaleString();
        document.getElementById('sumWithdraw').innerText = totalWit.toLocaleString();
        document.getElementById('sumBonus').innerText = totalBon.toLocaleString();
        document.getElementById('sumNet').innerText = (totalDep - totalWit).toLocaleString();
        
        document.getElementById('analyticsArea').classList.remove('hidden');
    }

    function renderChart(data) {
        const ctx = document.getElementById('memberChart').getContext('2d');
        document.getElementById('chartContainer').classList.remove('hidden');

        if (myChart) myChart.destroy(); // အဟောင်းရှိရင် ဖျက်ပါ

        myChart = new Chart(ctx, {
            type: 'bar', // သို့မဟုတ် 'doughnut' အကိုကြိုက်တာပြောင်းနိုင်ပါတယ်
            data: {
                labels: ['Deposit', 'Withdraw', 'Net Result'],
                datasets: [{
                    label: 'Member Analysis',
                    data: [
                        data.reduce((a, b) => a + (parseFloat(b.Deposit || b.Deposit_plus_) || 0), 0),
                        data.reduce((a, b) => a + (parseFloat(b.Withdraw || b.Withdraw_minus_) || 0), 0),
                        data.reduce((a, b) => a + (parseFloat(b.Deposit || b.Deposit_plus_) || 0), 0) - data.reduce((a, b) => a + (parseFloat(b.Withdraw || b.Withdraw_minus_) || 0), 0)
                    ],
                    backgroundColor: ['#10b981', '#ef4444', '#3b82f6']
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }
</script>
